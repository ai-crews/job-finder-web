<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Finder</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=<%= gaId %>"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        // debug_mode: true ì„¤ì •ìœ¼ë¡œ ë¡œì»¬(localhost)ì—ì„œë„ ì‹¤ì‹œê°„ ë°ì´í„° í™•ì¸ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
        gtag('config', '<%= gaId %>', { 'debug_mode': true });
    </script>
</head>
<body class="bg-[#F9FAFB]">
<header class="bg-[#3E5F44] text-white pt-12 pb-8 text-center">
    <h1 class="text-4xl font-bold mb-3">ìˆ˜ì‹œ ì±„ìš©ê³µê³  í™•ì¸</h1>
    <p class="text-xl mb-3">'ë°”ë¡œê°€ê¸°'ë¥¼ ëˆ„ë¥´ë©´ ìì„¸í•œ ì •ë³´ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”!</p>
</header>

<section class="max-w-5xl mx-auto px-4 mt-4 md:mt-8 mb-6">
    <div class="flex justify-start md:justify-center gap-2 md:gap-3 overflow-x-auto no-scrollbar pb-2">
        <button id="btn-all" onclick="filterJobs('all', this)"
                class="filter-btn whitespace-nowrap px-5 py-2 bg-[#FDE68A] border border-yellow-500 rounded-full text-xs md:text-sm font-bold transition-all shrink-0">
            ì „ì²´
        </button>
        <% ['MLì—”ì§€ë‹ˆì–´', 'ë°ì´í„°ì—”ì§€ë‹ˆì–´', 'ë°ì´í„°ë¶„ì„ê°€', 'AIë¦¬ì„œì¹˜', 'AIê¸°íšì'].forEach(tag => { %>
            <button onclick="filterJobs('<%= tag %>', this)"
                    class="filter-btn whitespace-nowrap px-5 py-2 bg-[#FEF9C3] border border-[#FDE68A] rounded-full text-xs md:text-sm font-medium hover:bg-[#FDE68A] transition-all shrink-0">
                <%= tag %>
            </button>
        <% }) %>
    </div>
</section>

<main class="max-w-5xl mx-auto px-4 pb-20 min-h-[50vh]" id="job-list">
    <% if (jobs && jobs.length > 0) { %>
        <%# 1. ê³µê³ ê°€ ìˆì„ ë•Œ: ê¸°ì¡´ì²˜ëŸ¼ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ %>
        <% jobs.forEach((job, index) => { %>
            <div class="job-card bg-white border border-gray-100 rounded-2xl p-6 md:p-8 mb-6 flex flex-col md:flex-row items-center shadow-sm transition-all"
                 data-job="<%= job[2] %>"
                 data-date="<%= job[4] %>"
                 data-index="<%= index %>">

                <div class="w-24 h-24 md:w-28 md:h-28 bg-gray-100 flex items-center justify-center rounded-xl mb-4 md:mb-0 md:mr-8 flex-shrink-0 overflow-hidden border border-gray-100">
                    <% if (job[6] && job[6].trim() !== '') { %>
                        <img src="<%= job[6] %>" alt="<%= job[0] %> ë¡œê³ " class="w-full h-full object-contain p-2"
                             onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');">
                        <span class="hidden text-black font-extrabold text-lg text-center"><%= job[0] %></span>
                    <% } else { %>
                        <div class="w-full h-full bg-[#FACC15] flex items-center justify-center p-4">
                            <span class="text-black font-extrabold text-lg text-center"><%= job[0] %></span>
                        </div>
                    <% } %>
                </div>

                <div class="flex-1 text-center md:text-left mb-6 md:mb-0">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2"><%= job[0] %></h2>
                    <div class="space-y-1 text-base md:text-lg">
                        <p class="text-gray-700"><span class="font-bold">ì±„ìš©ê³µê³ </span> <%= job[1] %></p>
                        <p class="text-gray-700"><span class="font-bold">ì§ë¬´ëª…</span> <%= job[2] %></p>
                    </div>
                    <div class="mt-4 flex flex-wrap justify-center md:justify-start items-center gap-3">
                        <span class="bg-[#FEF9C3] text-[#854D0E] px-3 py-1 rounded text-xs font-bold"><%= job[3] %></span>
                        <span class="text-xs md:text-sm text-gray-500">ì„œë¥˜ë§ˆê° <%= job[4] %></span>
                        <span class="bg-[#FFEDD5] text-[#9A3412] px-2 py-1 rounded text-xs font-bold">
                            ğŸ”¥ <%= job[7] || 0 %> ë²ˆ í™•ì¸ëœ ì±„ìš©ê³µê³  ì…ë‹ˆë‹¤! ğŸ”¥
                        </span>
                    </div>
                </div>

                <a href="<%= job[5] %>"
                   target="_blank"
                   onclick="trackJobClick('<%= job[0] %>', '<%= job[2] %>', '<%= job[1] %>', 'web', 'web')"
                   class="w-full md:w-auto text-center border-2 border-gray-200 px-8 py-3 rounded-xl font-bold text-gray-700 hover:bg-gray-50 transition-colors">
                    ë°”ë¡œê°€ê¸°
                </a>
            </div>
        <% }) %>
    <% } else { %>
        <%# 2. ê³µê³ ê°€ ì—†ì„ ë•Œ: ì•ˆë‚´ ë©”ì‹œì§€ ì¶œë ¥ %>
        <div class="flex flex-col items-center justify-center py-20 bg-white border border-dashed border-gray-200 rounded-3xl">
            <div class="text-6xl mb-4">â˜•</div>
            <p class="text-xl font-bold text-gray-900 mb-2">í˜„ì¬ ë“±ë¡ëœ ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <p class="text-gray-500 text-center">ë‚˜ì¤‘ì— ë‹¤ì‹œ ë°©ë¬¸í•´ ì£¼ì„¸ìš”!<br>ìƒˆë¡œìš´ ê³µê³ ë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</p>
        </div>
    <% } %>
        <div id="no-filter-results" class="hidden flex flex-col items-center justify-center py-20 bg-white border border-dashed border-gray-200 rounded-3xl">
            <div class="text-6xl mb-4">ğŸ”</div>
            <p class="text-xl font-bold text-gray-900 mb-2">í•´ë‹¹ ì§ë¬´ì˜ ê³µê³ ê°€ í˜„ì¬ ì—†ìŠµë‹ˆë‹¤.</p>
            <p class="text-gray-500 text-center px-4">ë‹¤ë¥¸ ì§ë¬´ë¥¼ ì„ íƒí•˜ì‹œê±°ë‚˜<br class="md:hidden"> ì „ì²´ ê³µê³ ë¥¼ í™•ì¸í•´ ë³´ì„¸ìš”!</p>
        </div>
</main>

<div id="pagination" class="flex justify-center gap-2 mt-8 mb-20">
</div>

<footer class="bg-[#3E5F44] text-white py-16 text-center">
    <h2 class="text-5xl md:text-7xl font-black mb-6 tracking-tighter" style="font-family: 'Montserrat', sans-serif;">
        JOB FINDER
    </h2>

    <div class="space-y-2 text-sm md:text-base font-medium opacity-90" style="font-family: 'Pretendard', sans-serif;">
        <p class="font-bold text-lg mb-1">ë‹¹ì‹ ì˜ ì„±ê³µì ì¸ ì»¤ë¦¬ì–´ë¥¼ ì‘ì›í•©ë‹ˆë‹¤</p>
    </div>
</footer>


<script>
    let currentPage = 1;
    const itemsPerPage = 10;

    // í˜ì´ì§€ë¥¼ ë³´ì—¬ì£¼ëŠ” í•µì‹¬ í•¨ìˆ˜
    function renderPage() {
        // 1. í˜„ì¬ í•„í„°ë§ëœ(ìˆ¨ê²¨ì§€ì§€ ì•Šì€) ì¹´ë“œë“¤ë§Œ ì¶”ì¶œ
        const allCards = Array.from(document.querySelectorAll('.job-card'));
        const visibleCards = allCards.filter(card => !card.classList.contains('filtered-out'));

        // ğŸ¯ ì¶”ê°€: í•„í„°ë§ëœ ê²°ê³¼ê°€ 0ê°œì¸ì§€ í™•ì¸
        const noResultMsg = document.getElementById('no-filter-results');
        if (visibleCards.length === 0) {
            if (noResultMsg) {
                noResultMsg.classList.remove('hidden');
                noResultMsg.classList.add('flex');
            }
        } else {
            if (noResultMsg) {
                noResultMsg.classList.add('hidden');
                noResultMsg.classList.remove('flex');
            }
        }

        const totalPages = Math.ceil(visibleCards.length / itemsPerPage);

        // 2. ëª¨ë“  ì¹´ë“œë¥¼ ì¼ë‹¨ ìˆ¨ê¹€
        allCards.forEach(card => card.style.display = 'none');

        // 3. í˜„ì¬ í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” ì¹´ë“œë§Œ ë³´ì—¬ì¤Œ
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;

        visibleCards.slice(start, end).forEach(card => {
            card.style.display = 'flex';
        });

        // 4. í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ìƒì„±
        renderPaginationButtons(totalPages);
    }

    // í•˜ë‹¨ ìˆ«ì ë²„íŠ¼ ìƒì„±
    function renderPaginationButtons(totalPages) {
        const paginationContainer = document.getElementById('pagination');
        paginationContainer.innerHTML = '';

        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement('button');
            btn.innerText = i;
            btn.className = `px-4 py-2 rounded-lg border ${i === currentPage ? 'bg-[#4c6b52] text-white border-[#3E5F44]' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`;
            btn.onclick = () => {
                currentPage = i;
                renderPage();
                window.scrollTo(0, 0); // í˜ì´ì§€ ì´ë™ ì‹œ ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            };
            paginationContainer.appendChild(btn);
        }
    }

    // ê¸°ì¡´ í•„í„° í•¨ìˆ˜ ìˆ˜ì •
    function filterJobs(category, element) {
        // 1. ëª¨ë“  í•„í„° ë²„íŠ¼ì˜ ìŠ¤íƒ€ì¼ì„ ê¸°ë³¸(ì—°í•œ ìƒ‰)ìœ¼ë¡œ ì´ˆê¸°í™”
        const buttons = document.querySelectorAll('.filter-btn');
        buttons.forEach(btn => {
            btn.classList.remove('bg-[#FDE68A]', 'border-yellow-500', 'font-bold');
            btn.classList.add('bg-[#FEF9C3]', 'border-[#FDE68A]', 'font-medium');
        });

        // 2. í˜„ì¬ í´ë¦­ëœ ë²„íŠ¼ë§Œ ì§„í•˜ê²Œ(ê°•ì¡°) ë³€ê²½
        element.classList.remove('bg-[#FEF9C3]', 'font-medium');
        element.classList.add('bg-[#FDE68A]', 'border-yellow-500', 'font-bold');

        // 3. ê¸°ì¡´ í•„í„°ë§ ë¡œì§ ìˆ˜í–‰
        const cards = document.querySelectorAll('.job-card');
        currentPage = 1;

        cards.forEach(card => {
            const jobType = card.getAttribute('data-job');
            if (category === 'all' || jobType.includes(category)) {
                card.classList.remove('filtered-out');
            } else {
                card.classList.add('filtered-out');
            }
        });

        renderPage();
    }

    function sortJobs() {
        const container = document.getElementById('job-list');
        const cards = Array.from(container.getElementsByClassName('job-card'));

        // ë¬´ì¡°ê±´ ë§ˆê°ê¸°í•œ(data-date) ìˆœìœ¼ë¡œ ì •ë ¬
        cards.sort((a, b) => {
            const dateA = a.getAttribute('data-date');
            const dateB = b.getAttribute('data-date');
            return dateA.localeCompare(dateB); // ì˜¤ë¦„ì°¨ìˆœ (ë¹¨ë¦¬ ë§ˆê°ë˜ëŠ” ìˆœ)
        });

        // ì •ë ¬ëœ ìˆœì„œëŒ€ë¡œ DOMì— ë‹¤ì‹œ ë°°ì¹˜
        cards.forEach(card => container.appendChild(card));
    }

    // index.ejsì˜ <script> íƒœê·¸ ì•ˆì— ì¶”ê°€
    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const dest = urlParams.get('url');

        // ğŸ¯ URLì—ì„œ source íŒŒë¼ë¯¸í„°ë¥¼ ì½ì–´ì˜¤ëŠ” ë¶‘ë¶„ (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ 'web')
        // n8n ë©”ì¼ ë§í¬ì—ëŠ” ?source=email ì´ ë¶™ì–´ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
        const source = urlParams.get('source') || 'web';

        //  URLì—ì„œ user_email íŒŒë¼ë¯¸í„° ì½ì–´ì˜¤ê¸°
        const userId = urlParams.get('user_id') || 'unknown';

        if (dest) {
            const company = urlParams.get('company');
            const jobTitle = urlParams.get('job_title');
            const recruitment = urlParams.get('recruitment_title');

            // ğŸ¯ 2. ì¶”ì  í•¨ìˆ˜ì— source ì •ë³´ë¥¼ í•¨ê»˜ ì „ë‹¬
            trackJobClick(company, jobTitle, recruitment, source, userId);

            const mainElement = document.getElementById('job-list');
            if (mainElement) {
                mainElement.innerHTML = `
            <div style="text-align:center; padding:100px 20px;">
                <h2 style="font-size:24px; font-weight:bold; color:#333;">${company} ê³µê³ ë¡œ ì´ë™ ì¤‘ì…ë‹ˆë‹¤...</h2>
                <p style="color:#666; margin-top:10px;">ìœ ì… ê²½ë¡œ: ${source === 'email' ? 'ğŸ“§ ë©”ì¼' : 'ğŸŒ ì›¹ì‚¬ì´íŠ¸'}</p>
                <p style="color:#666; margin-top:10px;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”. ğŸ¸</p>
            </div>`;
            }
            // í—¤ë”ì™€ í‘¸í„° ìˆ¨ê¸°ê¸°
            const header = document.querySelector('header');
            const footer = document.querySelector('footer');
            const filterSection = document.querySelector('.flex.justify-start'); // í•„í„° ë²„íŠ¼ ì˜ì—­
            const sortSelect = document.querySelector('#sort-select')?.parentElement; // ì •ë ¬ ì…€ë ‰íŠ¸ ë°•ìŠ¤

            if (header) header.style.display = 'none';
            if (footer) footer.style.display = 'none';
            if (filterSection) filterSection.style.display = 'none';
            if (sortSelect) sortSelect.style.display = 'none';

            setTimeout(() => {
                window.location.href = dest;
            }, 500);

            return;
        }

        if (!dest) {
            sortJobs();   // 1. í˜ì´ì§€ ë¡œë“œ ì‹œ ì •ë ¬ ë¨¼ì € í•˜ê³ 
            renderPage(); // 2. ê·¸ ë‹¤ìŒ í™”ë©´ì— ê·¸ë¦¬ê¸°
        }
    };

    // í´ë¦­ ì¶”ì  í•¨ìˆ˜ (ê¸°ì¡´ê³¼ ë™ì¼)
    function trackJobClick(company, job, recruitment, clickSource, userId) {
        gtag('event', 'click_job_link', {
            'company': company,
            'job_title': job,
            'recruitment_title': recruitment,
            'click_source': clickSource, // GA4ì—ì„œ ì´ ê°’ìœ¼ë¡œ í•„í„°ë§ ê°€ëŠ¥
            'user_id': userId, //ìœ ì € ë³„ í´ë¦­ í™œë™ ë¶„ì„
            'value': 1
        });

        // ì„œë²„ì— í´ë¦­ ì•Œë¦¼ (ì´ ë¶€ë¶„ì´ ì •í™•í•´ì•¼ í•©ë‹ˆë‹¤)
        fetch('/api/jobs/click', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json' // JSON í˜•ì‹ì„ì„ ëª…ì‹œ
            },
            body: JSON.stringify({
                recruitment_title: recruitment,
                company: company
            })
        })
            .then(res => res.json())
            .then(data => console.log('ì„±ê³µ:', data))
            .catch(err => console.error('ì—ëŸ¬:', err));
    }
</script>
</body>
</html>